<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kumano Kodo Map</title>

  <!-- Safariでも安定する v2.15.0 を使用 -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    html,body,#map{height:100%;margin:0}
    .popup{font:12px/1.45 system-ui,-apple-system,"Segoe UI",Roboto}
  </style>
</head>
<body>
<div id="map"></div>
<script>
  // === 固定設定（あなたのトークン＆スタイルに戻す） ===
  mapboxgl.accessToken = 'pk.eyJ1IjoicnNraW5lIiwiYSI6ImNtNmcwaXl0cjA4M2kya3BxdTF4aG80azAifQ.-6zqgbWGdGnEEeUSXr0iaA';
  const STYLE   = 'mapbox://styles/rskine/cmfnmhdf0007o01sj1pio430k'; // ←あなたのスタイル
  const OJI_URL = './kumanokodo_ooji.geojson';
  const BUS_URL = './kumano_nakahechi_bus_stops.geojson';

  const map = new mapboxgl.Map({
    container: 'map',
    style: STYLE,
    center: [135.5035, 33.7753], // 滝尻王子付近
    zoom: 13
  });

  async function loadGeoJSON(url){
    const r = await fetch(url, {cache:'no-cache'});
    if(!r.ok) throw new Error(`Fetch ${r.status}: ${url}`);
    const data = await r.json();
    if(!data || data.type!=='FeatureCollection' || !Array.isArray(data.features)){
      throw new Error(`Not a FeatureCollection: ${url}`);
    }
    return data;
  }

  function addCircleLayer(id, sourceId, color, minzoom){
    map.addLayer({
      id, type:'circle', source:sourceId, minzoom,
      paint:{
        'circle-radius':['interpolate',['linear'],['zoom'], 8,4, 14,6],
        'circle-color': color,
        'circle-stroke-color':'#fff',
        'circle-stroke-width':1
      }
    });
  }
  function addLabelLayer(id, sourceId, textExpr, minzoom){
    map.addLayer({
      id, type:'symbol', source:sourceId, minzoom,
      layout:{
        'text-field': textExpr,
        'text-size': ['interpolate',['linear'],['zoom'], 8,11, 14,14],
        'text-offset': [0, 1.1],
        'text-anchor': 'top'
      },
      paint:{ 'text-halo-color':'#fff', 'text-halo-width':1 }
    });
  }

  map.on('load', async () => {
    try{
      const [ojiData, busData] = await Promise.all([loadGeoJSON(OJI_URL), loadGeoJSON(BUS_URL)]);
      // ソース
      map.addSource('oji-src', { type:'geojson', data: ojiData });
      map.addSource('bus-src', { type:'geojson', data: busData });

      // 王子＝赤い丸＋ラベル
      addCircleLayer('oji-circle','oji-src','#d33');
      addLabelLayer('oji-label','oji-src',['coalesce',['get','name'],['get','name_en']]);

      // バス停＝緑の丸＋ラベル（ズームインでラベル表示）
      addCircleLayer('bus-circle','bus-src','#2a7');
      addLabelLayer('bus-label','bus-src',['get','name'], 11);

      // ポップアップ（丸レイヤーを対象）
      map.on('click','oji-circle',(e)=>{
        const p = e.features[0].properties||{};
        const lines = [];
        const title = p.name || p.name_en || 'Oji';
        lines.push(`<strong>${title}</strong>`);
        if (p.note) lines.push(p.note);
        if (p.official_url) lines.push(`<a href="${p.official_url}" target="_blank" rel="noopener">公式ページ</a>`);
        new mapboxgl.Popup({offset:12,className:'popup'}).setLngLat(e.lngLat).setHTML(lines.join('<br>')).addTo(map);
      });
      map.on('click','bus-circle',(e)=>{
        const p = e.features[0].properties||{};
        const ops = Array.isArray(p.operator)?p.operator:(p.operator?[p.operator]:[]);
        const routes = Array.isArray(p.routes)?p.routes:(p.routes?[p.routes]:[]);
        const html = [
          `<strong>${p.name||p.name_en||'Bus Stop'}</strong>`,
          ops.length ? `運行: ${ops.join(', ')}` : '',
          routes.length ? routes.join('<br>') : ''
        ].filter(Boolean).join('<br>');
        new mapboxgl.Popup({offset:12,className:'popup'}).setLngLat(e.lngLat).setHTML(html).addTo(map);
      });

      // カーソル
      ['oji-circle','bus-circle','oji-label','bus-label'].forEach(id=>{
        map.on('mouseenter', id, ()=> map.getCanvas().style.cursor='pointer');
        map.on('mouseleave', id, ()=> map.getCanvas().style.cursor='');
      });
    }catch(err){
      console.error('GeoJSON load failed:', err);
      alert('GeoJSONの読み込みでエラー: ' + err.message);
    }
  });
</script>
</body>
</html>
