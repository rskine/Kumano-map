<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kumano Kodo Map</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
  <style>
    html,body,#map{height:100%;margin:0}
    .popup{font:12px/1.4 system-ui,-apple-system,"Segoe UI",Roboto}
  </style>
</head>
<body>
<div id="map"></div>
<script>
  // ====== 設定 ======
  const CFG = {
    token: 'pk.eyJ1IjoicnNraW5lIiwiYSI6ImNtNmcwaXl0cjA4M2kya3BxdTF4aG80azAifQ.-6zqgbWGdGnEEeUSXr0iaA',  // ←あなたのMapbox Public Tokenに置き換えてください
    style: 'mapbox://styles/mapbox/outdoors-v12', // ←Mapbox StudioでpublishしたスタイルIDに置き換え
    center: [135.65, 33.84],
    zoom: 10,
    ojiUrl: './kumanokodo_ooji.geojson',
    busUrl: './kumano_nakahechi_bus_stops.geojson'
  };

  mapboxgl.accessToken = CFG.token;
  const map = new mapboxgl.Map({
    container: 'map',
    style: CFG.style,
    center: CFG.center,
    zoom: CFG.zoom
  });

  map.on('load', async () => {
    // 王子（赤い丸）
map.addLayer({
  id: 'oji-circle',
  type: 'circle',
  source: 'oji-src',
  paint: {
    'circle-radius': ['interpolate', ['linear'], ['zoom'], 8, 4, 14, 6],
    'circle-color': '#d33',
    'circle-stroke-color': '#fff',
    'circle-stroke-width': 1
  }
});

// バス停（緑の丸） ※一旦 minzoom なしで表示
map.addLayer({
  id: 'bus-circle',
  type: 'circle',
  source: 'bus-src',
  paint: {
    'circle-radius': ['interpolate', ['linear'], ['zoom'], 8, 3.5, 14, 5],
    'circle-color': '#2a7',
    'circle-stroke-color': '#fff',
    'circle-stroke-width': 1
  }
});

    // ポップアップ（王子）
    map.on('click','oji',(e)=>{
      const f = e.features[0], p = f.properties||{};
      const html = `
        <strong>${p.name||p.name_en||'Oji'}</strong><br>
        ${p.name_en?`${p.name_en}<br>`:''}
        ${p.note?`${p.note}<br>`:''}
        ${p.official_url?`<a href="${p.official_url}" target="_blank">公式ページ</a>`:''}
      `;
      new mapboxgl.Popup({offset:12,className:'popup'})
        .setLngLat(e.lngLat).setHTML(html).addTo(map);
    });

    // ポップアップ（バス停）
    map.on('click','bus',(e)=>{
      const f = e.features[0], p = f.properties||{};
      const ops = Array.isArray(p.operator)?p.operator:(p.operator?[p.operator]:[]);
      const routes = Array.isArray(p.routes)?p.routes:(p.routes?[p.routes]:[]);
      const html = `
        <strong>${p.name||p.name_en||'Bus Stop'}</strong><br>
        ${ops.length?`運行: ${ops.join(', ')}<br>`:''}
        ${routes.length?routes.join('<br>'):''}
      `;
      new mapboxgl.Popup({offset:12,className:'popup'})
        .setLngLat(e.lngLat).setHTML(html).addTo(map);
    });

    // カーソル変更
    ['oji','bus'].forEach(id=>{
      map.on('mouseenter',id,()=>map.getCanvas().style.cursor='pointer');
      map.on('mouseleave',id,()=>map.getCanvas().style.cursor='');
    });
  });
</script>
</body>
</html>
