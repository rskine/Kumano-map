<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kumano Kodo Map</title>

  <!-- Mapbox GL JS のCSSとJSを必ずここで読み込む -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    html,body,#map { height:100%; margin:0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
  mapboxgl.accessToken = 'pk.eyJ1IjoicnNraW5lIiwiYSI6ImNtNmcwaXl0cjA4M2kya3BxdTF4aG80azAifQ.-6zqgbWGdGnEEeUSXr0iaA';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/rskine/cmfnmhdf0007o01sj1pio430k', // ←戻す
  center: [135.5035, 33.7753],
  zoom: 13
});

  async function loadGeoJSON(url){
    const r = await fetch(url, {cache:'no-cache'});
    if(!r.ok) throw new Error(`Fetch ${r.status}: ${url}`);
    return r.json();
  }

  function addCircleLayer(id, sourceId, color){
    map.addLayer({
      id, type:'circle', source:sourceId,
      paint:{
        'circle-radius':['interpolate',['linear'],['zoom'], 8,4, 14,6],
        'circle-color': color,
        'circle-stroke-color':'#fff',
        'circle-stroke-width':1
      }
    });
  }

  map.on('load', async () => {
    try {
      // 相対パス（同じNetlifyサイト内）
      const ojiData = await loadGeoJSON('./kumanokodo_ooji.geojson');
      const busData = await loadGeoJSON('./kumano_nakahechi_bus_stops.geojson');
      console.log('OJIs:', ojiData.features.length, 'BUS:', busData.features.length);

      map.addSource('oji-src', { type:'geojson', data: ojiData });
      map.addSource('bus-src', { type:'geojson', data: busData });

      addCircleLayer('oji-circle', 'oji-src', '#d33'); // 赤
      addCircleLayer('bus-circle', 'bus-src', '#2a7'); // 緑

      // クリックでポップアップ
      map.on('click','oji-circle',(e)=>{
        const p = e.features[0].properties||{};
        new mapboxgl.Popup({offset:12})
          .setLngLat(e.lngLat)
          .setHTML(`<strong>${p.name||p.name_en||'Oji'}</strong>${p.note?'<br>'+p.note:''}`)
          .addTo(map);
      });
      map.on('click','bus-circle',(e)=>{
        const p = e.features[0].properties||{};
        const ops = Array.isArray(p.operator)?p.operator:(p.operator?[p.operator]:[]);
        const routes = Array.isArray(p.routes)?p.routes:(p.routes?[p.routes]:[]);
        new mapboxgl.Popup({offset:12})
          .setLngLat(e.lngLat)
          .setHTML(`<strong>${p.name||p.name_en||'Bus Stop'}</strong>${ops.length?'<br>運行: '+ops.join(', ') : ''}${routes.length?'<br>'+routes.join('<br>'):''}`)
          .addTo(map);
      });
    } catch (err) {
      console.error(err);
      alert('GeoJSON読み込みエラー: ' + err.message);
    }
  });
</script>
</body>
</html>
