<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kumano Kodo Map (fixed config)</title>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
  <style>
    html,body,#map{height:100%;margin:0}
    .popup{font:12px/1.4 system-ui,-apple-system,"Segoe UI",Roboto}
  </style>
</head>
<body>
<div id="map"></div>
<script>
  // ---- 固定設定（クエリは使わない）----
  const TOKEN   = 'pk.eyJ1IjoicnNraW5lIiwiYSI6ImNtNmcwaXl0cjA4M2kya3BxdTF4aG80azAifQ.-6zqgbWGdGnEEeUSXr0iaA';
  const STYLE   = 'mapbox://styles/rskine/cmfnmhdf0007o01sj1pio430k'; // ←あなたのスタイル
  const OJI_URL = 'https://kumap.netlify.app/kumanokodo_ooji.geojson';
  const BUS_URL = 'https://kumap.netlify.app/kumano_nakahechi_bus_stops.geojson';
  const CENTER  = [135.5035, 33.7753]; // 滝尻王子付近
  const ZOOM    = 13;

  mapboxgl.accessToken = TOKEN;
  const map = new mapboxgl.Map({ container:'map', style:STYLE, center:CENTER, zoom:ZOOM });

  async function loadGeoJSON(url){
    const r = await fetch(url, {cache:'no-cache'});
    if(!r.ok) throw new Error(`Fetch ${r.status}: ${url}`);
    const data = await r.json();
    if(!data || data.type!=='FeatureCollection' || !Array.isArray(data.features)){
      throw new Error(`Not a FeatureCollection: ${url}`);
    }
    return data;
  }

  function addCircleLayer(id, sourceId, color){
    map.addLayer({
      id, type:'circle', source:sourceId,
      paint:{
        'circle-radius':['interpolate',['linear'],['zoom'], 8,4, 14,6],
        'circle-color':color, 'circle-stroke-color':'#fff', 'circle-stroke-width':1
      }
    });
  }

  map.on('load', async () => {
    try{
      const [ojiData, busData] = await Promise.all([loadGeoJSON(OJI_URL), loadGeoJSON(BUS_URL)]);
      console.log('OJIs:', ojiData.features.length, 'BUS:', busData.features.length);

      map.addSource('oji-src', {type:'geojson', data:ojiData});
      map.addSource('bus-src', {type:'geojson', data:busData});
      addCircleLayer('oji-circle','oji-src','#d33');
      addCircleLayer('bus-circle','bus-src','#2a7');

      map.on('click','oji-circle',(e)=>{
        const p = e.features[0].properties||{};
        new mapboxgl.Popup({offset:12, className:'popup'})
          .setLngLat(e.lngLat)
          .setHTML(`<strong>${p.name||p.name_en||'Oji'}</strong><br>${p.note||''}${p.official_url?`<br><a href="${p.official_url}" target="_blank">公式</a>`:''}`)
          .addTo(map);
      });
      map.on('click','bus-circle',(e)=>{
        const p = e.features[0].properties||{};
        const ops = Array.isArray(p.operator)?p.operator:(p.operator?[p.operator]:[]);
        const routes = Array.isArray(p.routes)?p.routes:(p.routes?[p.routes]:[]);
        new mapboxgl.Popup({offset:12, className:'popup'})
          .setLngLat(e.lngLat)
          .setHTML(`<strong>${p.name||p.name_en||'Bus Stop'}</strong><br>${ops.length?`運行: ${ops.join(', ')}`:''}${routes.length?`<br>${routes.join('<br>')}`:''}`)
          .addTo(map);
      });
    }catch(err){
      console.error('GeoJSON load failed:', err);
      alert('GeoJSONの読み込みでエラー: ' + err.message);
    }
  });
</script>
</body>
</html>
